import Head from 'next/head';
// import Image from 'next/image';
import { useEffect, useRef, useState } from 'react';
import axios from 'axios';
import styles from '../styles/Home.module.css';

interface HomeProps {
  preloadData: Launch[];
  apiUrl: string;
}

const { PUBLIC_URL, API_SLUG } = process.env;
const TIMEOUT = 10000;

// This gets called on every request
export async function getServerSideProps() {
  const apiURL = `${PUBLIC_URL}${API_SLUG}`;
  const { data } = await axios.get<Launch[]>(apiURL);

  // Pass data to the page via props
  return { props: { preloadData: data, apiUrl: apiURL } };
}

export default function Home(props: HomeProps) {
  const { preloadData, apiUrl } = props;
  const [launches, setLaunches] = useState<Launch[]>(preloadData);
  const timeoutRef = useRef<NodeJS.Timeout>();

  const fetchLaunches = async () => {
    clearTimeout(timeoutRef.current);
    const { data } = await axios.get<Launch[]>(apiUrl);
    timeoutRef.current = setTimeout(fetchLaunches, TIMEOUT);
    setLaunches(data);
  };

  useEffect(() => {
    // timeoutRef.current = setTimeout(fetchLaunches, TIMEOUT);
    return () => clearTimeout(timeoutRef.current);
  }, []);

  return (
    <div className={styles.container}>
      <Head>
        <title>SpaceX Launch API</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <main className={styles.main}>
        {launches.map((launch) => (
          <div key={launch.id}>{launch.name}</div>
        ))}
      </main>
    </div>
  );
}
